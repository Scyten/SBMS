<!DOCTYPE html>
<html>
<head>
    <title>ElectroDacus</title>
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
    <!--<meta http-equiv='refresh' content='3'>-->
    <link rel="stylesheet" href="SBMS.css"/>
    <link rel="stylesheet" href="marco.css"/>
    <link rel="icon" type="image/png" href="favicon.png"/>
    <style media='screen' type='text/css'></style>
    <script language="JavaScript" type="application/javascript" src="jquery-3.3.1.min.js"></script>
    <script language="JavaScript" type="application/javascript" src="all.js"></script>
</head>
<body>
<div id="error">
    ERROR: CANNOT CONNECT TO SBMS
    <br>
    <pre id="error-retry"></pre>
</div>

<div id="useless">
    <!--<div4 id='mo0'>PV1 & PV2</div4>-
    <div4 id='mo2' style='left:240px;'>Battery</div4>
    <div4 id='mo1' style='left:480px;'>Load</div4>-->
    <!--<div2 style='display: none;' id='id'></div2>-->
</div>

<div id="container">
    <div id="leftPanel">
        <div id="topleft">
            <div class="panel">

                <span class="section-title">Info</span>
                <div id="first">
                    <div class="infoBar">
                        <span class="infoBarTitle">System type</span>
                        <span id="infoBarValue1" class="infoBarValue"></span>
                    </div>
                    <div class="infoBar">
                        <span class="infoBarTitle">Maximum capacity</span>
                        <span id="infoBarValue2" class="infoBarValue"></span>
                    </div>
                    <div class="infoBar">
                        <span class="infoBarTitle">System status</span>
                        <span id="infoBarValue3" class="infoBarValue"></span>
                    </div>
                    <div class="infoBar">
                        <span class="infoBarTitle">Interior temperature</span>
                        <span id="infoBarValue4" class="infoBarValue"></span>
                        <div id="intTemperatureLed" class="led temperature"></div>
                    </div>
                    <div class="infoBar">
                        <span class="infoBarTitle">Exterior temperature</span>
                        <span id="infoBarValue5" class="infoBarValue"></span>
                        <div id="extTemperatureLed" class="led temperature"></div>
                    </div>
                    <div class="infoBar">
                        <span class="infoBarTitle">Battery voltage</span>
                        <span id="infoBarValue6" class="infoBarValue"></span>
                    </div>
                    <div class="infoBar">
                        <span class="infoBarTitle">Cell &#916</span>
                        <span id="infoBarValue7" class="infoBarValue"></span>
                    </div>
                    <div class="infoBar">
                        <span class="infoBarTitle">Model</span>
                        <span id="id" class="infoBarValue"></span>
                    </div>
                </div>
            </div>
        </div>
        <div id="topright">
            <div class="panel">
                <span class="section-title">Status</span>
                <div id="second">
                    <!--<meter id='bat' style='height: 40px; width: 220px; top: 9px;' min='0' low='20' max='100'></meter>-->
                    <div class="battery-container battery">
                        <div class="meter-gloss"></div>
                        <div id="battery" class="meter-fill"></div>
                    </div>
                    <meter style='height: 20px; left: 271px; top:23px; width: 5px;' min='2' max='8' value='0'></meter>
                    <div2 style='color:#000;font-size:200%;top:25px;left:115px;text-align: center; text-shadow: -1px -1px 4px #efc;'
                          id='SOC'></div2>

                    <div id="status-leds">
                        <div id="led0">PV1 <!--& PV2-->
                            <div class="led led-yellow"></div>
                        </div>
                        <div id="led2">BATTERY
                            <div class="led led-yellow"></div>
                        </div>
                        <div id="led1">LOAD
                            <div class="led led-yellow"></div>
                        </div>
                    </div>
                </div>
            </div>

        <div class="panel">
            <span class="section-title">Cells</span>
            <div id="third">
                <!--
                <div class="meter-container battery">
                    <div class="meter-gloss"></div>
                    <div id="battery" class="meter-fill"></div>
                </div>
                -->
                <div class="largeBar" id="lBar">
                    <div2 style='left:20px; color:#00a9da;' id='d2'>
                        <span>Cell 1</span>
                        <br><span>Cell 2</span>
                        <br><span>Cell 3</span>
                        <br><span>Cell 4</span>
                        <br><span>Cell 5</span>
                        <br><span>Cell 6</span>
                        <br><span>Cell 7</span>
                        <br><span>Cell 8</span>
                    </div2>
                    <div2 style='left:115px; color: #00a9da;' id='d3'>
                        <span></span>
                        <br><span></span>
                        <br><span></span>
                        <br><span></span>
                        <br><span></span>
                        <br><span></span>
                        <br><span></span>
                        <br><span></span>
                    </div2>
                    <div2 style='left:165px;color:#888;' id='d4'>
                        <span>V</span>
                        <br><span>V</span>
                        <br><span>V</span>
                        <br><span>V</span>
                        <br><span>V</span>
                        <br><span>V</span>
                        <br><span>V</span>
                        <br><span>V</span>
                    </div2>
                    <div2 style='left:200px;' id='mt1'>
                        <div class="cell-container cell">
                            <div class="meter-gloss"></div>
                            <div id="cell0" class="meter-fill"></div>
                        </div>
                        <div class="cell-container cell">
                            <div class="meter-gloss"></div>
                            <div id="cell1" class="meter-fill"></div>
                        </div>
                        <div class="cell-container cell">
                            <div class="meter-gloss"></div>
                            <div id="cell2" class="meter-fill"></div>
                        </div>
                        <div class="cell-container cell">
                            <div class="meter-gloss"></div>
                            <div id="cell3" class="meter-fill"></div>
                        </div>
                        <div class="cell-container cell">
                            <div class="meter-gloss"></div>
                            <div id="cell4" class="meter-fill"></div>
                        </div>
                        <div class="cell-container cell">
                            <div class="meter-gloss"></div>
                            <div id="cell5" class="meter-fill"></div>
                        </div>
                        <div class="cell-container cell">
                            <div class="meter-gloss"></div>
                            <div id="cell6" class="meter-fill"></div>
                        </div>
                        <div class="cell-container cell">
                            <div class="meter-gloss"></div>
                            <div id="cell7" class="meter-fill"></div>
                        </div>
                    </div2>
                </div>
            </div>
        </div>
</div>
    </div>
    
    <div id="rightPanel">
        <div id="date-time" class="simple-panel" style="height: 145px;">
            <time id="date"></time>
            <time id="time"></time>
            <div class="button-container">
                <button onclick="dload('sbms.txt', localStorage['sbms']);">SAVE LOG</button>
                <button onclick="localStorage.removeItem('sbms');localStorage['sbms'] ='';">CLEAR LOG</button>
            </div>
        </div>
        <div id="details" class="simple-panel" style="height: 145px;">
            <div3>
                <div2 style="color:#00a9da;top:22px;" id="d6">
                    Batt<br>PV1<!--<br>PV2<br>PV1+PV2--><br>Load<br>ExtLd<br>Charged<br>
                </div2>
                <div2 id="d7">
                	[A]
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br>
                </div2>
                <div2 id="d8">
                    [W]
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br>
                </div2>
                <div2 id="d9">
                    [mAh]
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br>
                </div2>
                <div2 id="d10">
                    [Wh]
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br><span></span>
                    <br>
                </div2>
                <div5 style="width: 600px;top:0px;height:22px;" id="d11"></div5>
            </div3>
        </div>

        <div class="simple-panel">
            <div class="graph-panel">
                <div class="fan">
                    <img id="fan0-0" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-yellow"></span>
                    <br>PV1<br>
                    <span id="avg0-0"></span>
                </div>
                <br>
                <div class="fan">
                    <img id="fan0-1" src="fan.png"/>
                </div>
                <!--<div class="legend">
                    <span class="laser laser-cyan"></span>
                    <br>PV2<br>
                    <span id="avg0-1"></span>
                </div>-->
            </div>
            <div3>
                <!--<div style='background: #fb9;width: 720px;height:25px;'></div>-->
                <div12h id='g0'></div12h>
                <div1h id='g1'></div1h>
                <div1m id='g2'></div1m>
                <div id='ch0' style='width: 360px;height: 135px;'></div>
                <div class="graph-info first"><span id="graph-info-0-0"></span></div>
                <div class="graph-info second"><span id="graph-info-0-1"></span></div>
                <div class="graph-info third"><span id="graph-info-0-2"></span></div>
                <span class="hours12">12h</span>
                <span class="hour1">1h</span>
                <span class="min1">1m</span>
            </div3>
        </div>

        <div class="simple-panel">
            <div class="graph-panel">
                <div class="fan">
                    <img id="fan3-0" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-green"></span>
                    <br>Batp<br>
                    <span id="avg3-0"></span>
                </div>
                <br>
                <div class="fan">
                    <img id="fan3-1" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-red"></span>
                    <br>Batn<br>
                    <span id="avg3-1"></span>
                </div>
            </div>
            <div3>
                <!--<div style='background: #fb9;width: 720px;height:25px;'></div>-->
                <div12h id='g3'></div12h>
                <div1h id='g4'></div1h>
                <div1m id='g5'></div1m>
                <div id='ch1' style='width: 360px;height: 135px;'></div>
                <div class="graph-info first"><span id="graph-info-3-0"></span></div>
                <div class="graph-info second"><span id="graph-info-3-1"></span></div>
                <div class="graph-info third"><span id="graph-info-3-2"></span></div>
                <span class="hours12">12h</span>
                <span class="hour1">1h</span>
                <span class="min1">1m</span>
            </div3>
        </div>

        <div class="simple-panel">
            <div class="graph-panel">
                <div class="fan">
                    <img id="fan6-0" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-blue"></span>
                    <br>Load<br>
                    <span id="avg6-0"></span>
                </div>
                <br>
                <div class="fan">
                    <img id="fan6-1" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-magenta"></span>
                    <br>ExLd<br>
                    <span id="avg6-1"></span>
                </div>
            </div>
            <div3>
                <!--<div style='background: #fb9;width: 720px;height:25px;'></div>-->
                <div12h id='g6'></div12h>
                <div1h id='g7'></div1h>
                <div1m id='g8'></div1m>
                <div id='ch2' style='width: 360px;height: 135px;'></div>
                <div class="graph-info first"><span id="graph-info-6-0"></span></div>
                <div class="graph-info second"><span id="graph-info-6-1"></span></div>
                <div class="graph-info third"><span id="graph-info-6-2"></span></div>
                <span class="hours12">12h</span>
                <span class="hour1">1h</span>
                <span class="min1">1m</span>
            </div3>
        </div>
    </div>
</div>

<script>
    let searchParams = new URLSearchParams(window.location.search);
    let currentEncodedData = "";
    // searchParams.has('sent');

    const interval = parseInt(searchParams.get('interval'));
    const LOCAL_DEBUG = parseInt(searchParams.get('debug'));

    const USE_SERIAL_DATA = parseInt(searchParams.get('use_serial_data'));
    const DATA_INTERVAL_OK = isNaN(interval) ? 2000 : interval;
    const DATA_INTERVAL_ERROR = 10000;
    const DATA_FETCH_TIMEOUT = 3000;
    const FAN_MAX_SPEED = 0.5;
    const FAN_MIN_SPEED = 3;
    const FAN_DELTA = FAN_MIN_SPEED - FAN_MAX_SPEED;
    const batteryPercentRange = {min: 10, max: 100};
    const intTemperatureRange = {min: 5, max: 40};
    const extTemperatureRange = {min: 5, max: 40};

    var counter = 1;
    var ledsStatus = [1, 1, 1];
    var averages = [];
    averages[0] = [-1, -1];
    averages[3] = [-1, -1];
    averages[6] = [-1, -1];

    function reset() {
        $('#ch0, #ch1, #ch2').empty();
        // $('#d2, #d3, #d4, #d6, #d7, #d8, #d9, #d10, #d11, #d12, #mt1, #g0, #g1, #g2, #g3, #g4, #g5, #g6, #g7, #g8, #ch0, #ch1, #ch2').empty();
    }

    function displayDateTime() {
        let date = new Date();
        let n = date.toDateString();
        let time = date.toLocaleTimeString();
        $('#date').html(n);
        $('#time').html(time);
    }

    function getBatteryHslColor(value, min, max) {
        //value from 0 to 1
        value = (value - min) / (max - min);
        let hue = (value * 120).toString(10);
        return {
            percent: value * 100.0,
            background: ['linear-gradient(hsl(', hue, ',90%,80%), hsl(', hue, ',90%,50%), hsl(', hue, ',90%,50%), hsl(', hue, ',90%,30%))'].join("")
        };
    }

    function getTemperatureHslColor(value, min, max) {
        //value from 0 to 1
        value = (value - min) / (max - min);
        var hue = ((value * 120) + 240).toString(10);
        return {
            hue: "hsl(" + hue + ",90%,50%)",
            box_shadow: ['rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset hsl(', hue, ',90%,50%) 0 -1px 9px, hsl(', hue, ',90%,50%) 0 -2px 20px 5px;'].join("")
        };

    }

    function setFanRotation(fanId1, fanId2) {
        var selector = "#fan" + fanId1 + "-" + fanId2;
        $("#avg" + fanId1 + "-" + fanId2).html(averages[fanId1][fanId2] + "%");

        // If average value is 0, set random rotation
        if (averages[fanId1][fanId2] <= 0) {
            $(selector).css('transform', 'rotate(' + Math.random() * 120 + 'deg)');
            $(selector).css('-webkit-animation', 'none').css('-moz-animation', 'none').css('animation', 'none');
        }
        else {
            var css = "spin " + (((100 - averages[fanId1][fanId2]) / 100 * FAN_DELTA) + FAN_MAX_SPEED) + "s linear infinite";
            $(selector).css('-webkit-animation', css).css('-moz-animation', css).css('animation', css);
        }
    }

    function parseData() {
        reset();
        sessionStorage['PV1'] = typeof PV1 == "undefined"? '': PV1;
        sessionStorage['PV2'] = typeof PV2 == "undefined"? '': PV2;
        sessionStorage['Batp'] = typeof Btp == "undefined"? '': Btp;
        sessionStorage['Batn'] = typeof Btn == "undefined"? '': Btn;
        sessionStorage['Ld'] = typeof Ld == "undefined"? '': Ld;
        sessionStorage['ELd'] = typeof ELd == "undefined"? '': ELd;

        localStorage['sbmsb'] = typeof sbms == "undefined"? '': sbms;
        localStorage['xsbms'] = typeof xsbms == "undefined"? '': xsbms;
        localStorage['gsbms'] = typeof gsbms == "undefined"? '': gsbms;
        localStorage['eA'] = typeof eA == "undefined"? '': eA;
        localStorage['eW'] = typeof eW == "undefined"? '': eW;
        localStorage['cap'] = typeof s1 == "undefined"? '': s1[0];
        localStorage['WA'] = typeof s1 == "undefined"? '': s1[1];
        localStorage['model'] = typeof s1 == "undefined"? '': s1[2];
        localStorage['sbms2'] = typeof s2 == "undefined"? '': JSON.stringify(s2);
        localStorage['sbms'] = typeof sbms == "undefined"? '': localStorage['sbms'] + sbms + '\n';

        all();
    }

    function executeSerialDataFile() {
        document.getElementById("serial-data-loader");
        // document.getElementById("serial-data-loader").remove();
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.src = "serial_data.js?" + new Date();
        script.id = "serial-data-loader";
        head.appendChild(script);
    }

    function DisplaySerialData(data) {
        if (currentEncodedData == data) return;
        sbms = currentEncodedData = data;

        $('#error').fadeOut('fast');
        parseData();
        startDataFetchTimer(DATA_INTERVAL_OK);
    }

    function startDataFetchTimer(miliseconds) {
        console.log(miliseconds);
        setTimeout(getData, miliseconds);
    }

    function getData() {
        var dataUrl = LOCAL_DEBUG ? "test_data/data" + counter + ".js" : "http://192.168.4.1/";
        // var dataUrl = LOCAL_DEBUG ? "test_data/data_developer.js" : "http://192.168.4.1/";
        console.log(dataUrl);

        if (LOCAL_DEBUG) {
            $('#localTestDataScript').off('ready load').remove();

            scriptTag = document.body.appendChild(document.createElement('script'));
            scriptTag.id = 'localTestDataScript';
            $('#localTestDataScript').on('load', function () {
                console.log('load');
                parseData();
                startDataFetchTimer(DATA_INTERVAL_OK);
                if (LOCAL_DEBUG) (counter < 5) ? ++counter : counter = 1;
            });
            scriptTag.src = dataUrl;
        } else if (USE_SERIAL_DATA) {
            executeSerialDataFile();
        } else {
            $.ajax({
                url: dataUrl,
                dataType: "script",
                timeout: DATA_FETCH_TIMEOUT
            }).done(function (script, textStatus) {
                $('#error').fadeOut('fast');
                parseData();
                startDataFetchTimer(DATA_INTERVAL_OK);
                console.log(textStatus);
            }).fail(function (jqxhr, settings, exception) {
                // $('#error-retry').empty().append("retrying in "+DATA_INTERVAL_ERROR/1000+" seconds ...\n");
                // $('#error').fadeIn('fast');
                startDataFetchTimer(DATA_INTERVAL_ERROR);
                console.log("retrying in " + DATA_INTERVAL_ERROR / 1000 + " seconds ...\n");
            }).always(function () {
                if (LOCAL_DEBUG) (counter < 5) ? ++counter : counter = 1;
            });
        }
    }

    all();

    function dload(n, t) {
        var pom = document.createElement('a');
        pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(t));
        pom.setAttribute('download', n);
        if (document.createEvent) {
            var event = document.createEvent('MouseEvents');
            event.initEvent('click', true, true);
            pom.dispatchEvent(event);
        }
        else {
            pom.click();
        }
    }

    $(function () {
        startDataFetchTimer(0);
        displayDateTime();
        setInterval(displayDateTime, 1000);
    })
</script>
</body>
</html>



























